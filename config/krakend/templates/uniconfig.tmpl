{{range $index_in_range, $not_used_element := $.range}}
{{if gt $index_in_range 0}},{{end}}

{{range $host_index, $host := $.hosts}}
{{if gt $host_index 0}},{{end}}
{
    "endpoint": "/api/{{$host}}/operations{{range $index_for_uri, $not_used_element2 := $.range -}} {{- if le $index_for_uri $index_in_range -}} /{{"{"}}n_{{$index_for_uri}}{{"}" -}} {{end}}{{end}}",
    "method": "POST",
    {{ include "uniconfig_partial_1.tmpl" }}
    "backend": [
    {
        "url_pattern": "/rests/operations{{range $index_for_uri, $not_used_element2 := $.range -}} {{- if le $index_for_uri $index_in_range -}} /{{"{"}}n_{{$index_for_uri}}{{"}" -}} {{end}}{{end}}",
        {{ include "uniconfig_partial_2.tmpl" }}
        "host": [
	        "https://{{$host}}:8181"
        ]
    }
    ]
}
{{end}}
{{end}}
,

{{range $method_index, $method := .methods}}
{{if gt $method_index 0}},{{end}}

{{range $index_in_range, $not_used_element := $.range}}
{{if gt $index_in_range 0}},{{end}}

{{range $host_range, $host := $.hosts}}
{{if gt $host_range 0}},{{end}}

{
    "endpoint": "/api/{{$host}}/data{{range $index_for_uri, $not_used_element2 := $.range -}} {{- if le $index_for_uri $index_in_range -}} /{{"{"}}n_{{$index_for_uri}}{{"}" -}} {{end}}{{end}}",
    "method": "{{$method}}",
    {{ include "uniconfig_partial_1.tmpl" }}
    "backend": [
    {
        "url_pattern": "/rests/data{{range $index_for_uri, $not_used_element2 := $.range -}} {{- if le $index_for_uri $index_in_range -}} /{{"{"}}n_{{$index_for_uri}}{{"}" -}} {{end}}{{end}}",
        {{ include "uniconfig_partial_2.tmpl" }}
        "host": [
            "https://{{$host}}:8181"
        ]
    }
],
    "extra_config": {
        "@comment": "Fixing escape queries with multiple fields separated by semicolon",
        "github.com/devopsfaith/krakend-lua/router": {
            "sources": ["scripts/query_escape.lua"],
            "allow_open_libs": true,
            "pre": "local r = ctx.load(); r:url(urlencode(r));",
            "live": true
        }
    }
}
{{end}}
{{end}}
{{end}},
{
    "endpoint": "/static/list/uniconfig",
    "method": "GET",
    "backend": [
        {
        }
    ],
    "extra_config": {
        "github.com/devopsfaith/krakend/proxy": {
            "static": {
                "strategy": "always",
                "data": {
                    "instances": {{ marshal .hosts }}
                }
            }
        }
    }
}